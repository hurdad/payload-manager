syntax = "proto3";

package payload.manager.services.v1;

import "google/protobuf/empty.proto";

import "payload/manager/runtime/v1/lifecycle.proto";
import "payload/manager/runtime/v1/tiering.proto";
import "payload/manager/catalog/v1/catalog.proto";
import "payload/manager/catalog/v1/lineage.proto";

/*
  PayloadCatalogService

  This service manages durable state and semantic meaning of payloads.

  Responsibilities:
    - Allocate and commit payload lifecycle
    - Promotion and durability operations
    - Deletion
    - Metadata storage
    - Lineage tracking

  This is NOT the data plane.
  Workers should use PayloadDataService for reading bytes.
*/

service PayloadCatalogService {

  // ---------------------------------------------------------------------------
  // Lifecycle
  // ---------------------------------------------------------------------------

  /*
    Allocate reserves placement but the payload is invisible to readers
    until CommitPayload succeeds.
  */
  rpc AllocatePayload(payload.manager.runtime.v1.AllocatePayloadRequest)
      returns (payload.manager.runtime.v1.AllocatePayloadResponse);

  /*
    Marks payload immutable and readable.
    After this point the payload must never change.
  */
  rpc CommitPayload(payload.manager.runtime.v1.CommitPayloadRequest)
      returns (payload.manager.runtime.v1.CommitPayloadResponse);

  /*
    Deletes payload placement and metadata.

    If force=true:
      - active leases are invalidated immediately
      - future reads must fail
  */
  rpc Delete(payload.manager.runtime.v1.DeleteRequest)
      returns (google.protobuf.Empty);


  // ---------------------------------------------------------------------------
  // Tiering & Durability
  // ---------------------------------------------------------------------------

  /*
    Requests movement to a higher tier (RAM/GPU/etc).
  */
  rpc Promote(payload.manager.runtime.v1.PromoteRequest)
      returns (payload.manager.runtime.v1.PromoteResponse);

  /*
    Requests durable storage (usually disk/object storage).

    BLOCKING policy waits until durable or failure.
  */
  rpc Spill(payload.manager.runtime.v1.SpillRequest)
      returns (payload.manager.runtime.v1.SpillResponse);


  // ---------------------------------------------------------------------------
  // Lineage
  // ---------------------------------------------------------------------------

  /*
    Records descriptive relationships between payloads.

    Does NOT enforce execution order.
  */
  rpc AddLineage(payload.manager.catalog.v1.AddLineageRequest)
      returns (google.protobuf.Empty);

  rpc GetLineage(payload.manager.catalog.v1.GetLineageRequest)
      returns (payload.manager.catalog.v1.GetLineageResponse);


  // ---------------------------------------------------------------------------
  // Metadata
  // ---------------------------------------------------------------------------

  /*
    Updates current metadata view.
  */
  rpc UpdatePayloadMetadata(payload.manager.catalog.v1.UpdatePayloadMetadataRequest)
      returns (payload.manager.catalog.v1.UpdatePayloadMetadataResponse);

  /*
    Appends immutable metadata history event.
  */
  rpc AppendPayloadMetadataEvent(payload.manager.catalog.v1.AppendPayloadMetadataEventRequest)
      returns (payload.manager.catalog.v1.AppendPayloadMetadataEventResponse);
}
