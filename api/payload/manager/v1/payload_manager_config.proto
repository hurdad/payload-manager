syntax = "proto3";

package payload.manager.config.v1;

/*
  Payload Manager Configuration (v1)

  Static configuration loaded at startup (YAML / JSON).
  Defines storage tiers, metadata backends, and control-plane behavior.

  This config supports:
    - Multi-GPU systems
    - RAM / Disk tiers
    - Object storage (S3 / MinIO)
    - TimescaleDB metadata backend
*/

import "google/protobuf/duration.proto";
import "payload/manager/v1/commo.proto";


// =======================
// TOP-LEVEL CONFIG
// =======================

message PayloadManagerConfig {

  // Human-readable identifier (hostname, pod name, etc.)
  string node_id = 1;

  // Global defaults for payload policies
  GlobalPolicyDefaults policy_defaults = 2;

  // Metadata / lineage backend (TimescaleDB, etc.)
  MetadataBackend metadata_backend = 3;

  // Storage tiers configuration
  StorageConfig storage = 4;

  // Lease behavior
  LeaseConfig leases = 5;

  // Observability / metrics
  ObservabilityConfig observability = 6;
}


// =======================
// GLOBAL POLICY DEFAULTS
// =======================

message GlobalPolicyDefaults {
  payload.manager.common.v1.EvictionPriority default_eviction_priority = 1;
  bool require_durable_by_default = 2;
  payload.manager.common.v1.Tier default_spill_target = 3;
}


// =======================
// METADATA BACKEND
// =======================

message MetadataBackend {
  oneof backend {
    TimescaleDBBackend timescaledb = 1;
  }
}

message TimescaleDBBackend {
  string connection_uri = 1;
  string schema = 2;
  uint32 max_connections = 3;
  google.protobuf.Duration connect_timeout = 4;
  bool enable_hypertables = 5;
  bool auto_migrate = 6;
  google.protobuf.Duration metadata_event_retention = 7;
  google.protobuf.Duration lineage_retention = 8;
}


// =======================
// STORAGE CONFIG
// =======================

message StorageConfig {

  // GPU tier (multi-GPU aware)
  GpuStorageConfig gpu = 1;

  // RAM tier
  RamStorageConfig ram = 2;

  // Local disk tier
  DiskStorageConfig disk = 3;

  // Remote object storage tier
  ObjectStorageConfig object = 4;
}


// =======================
// GPU (MULTI-DEVICE)
// =======================

/*
  GPU storage configuration.

  Supports multiple heterogeneous GPUs.
*/
message GpuStorageConfig {

  // Enable GPU tier at all
  bool enabled = 1;

  // If empty, manager may auto-discover devices (implementation-defined).
  repeated GpuDeviceConfig devices = 2;

  // Allocation strategy across GPUs.
  GpuAllocationStrategy allocation_strategy = 3;
}

/*
  Describes a single GPU device managed by this instance.
*/
message GpuDeviceConfig {

  // CUDA device index (as seen by the process)
  uint32 device_id = 1;

  // Optional human-readable name (e.g. "A100-80GB", "RTX4090")
  string name = 2;

  // Maximum bytes the payload manager may use on this GPU
  uint64 max_bytes = 3;

  // Optional tags / capabilities for future placement decisions
  // Examples: ["tensor", "fp16", "mig"]
  repeated string tags = 4;

  // Optional NUMA node hint (for GPU â†” RAM locality)
  uint32 numa_node = 5;

  // Enable/disable this GPU explicitly
  bool enabled = 6;
}

/*
  Strategy for choosing a GPU when allocating/promoting payloads.
*/
enum GpuAllocationStrategy {
  GPU_ALLOCATION_STRATEGY_UNSPECIFIED = 0;

  // Choose GPU with most free capacity
  GPU_ALLOCATION_STRATEGY_MOST_FREE = 1;

  // Round-robin across enabled GPUs
  GPU_ALLOCATION_STRATEGY_ROUND_ROBIN = 2;

  // Prefer lowest device_id first
  GPU_ALLOCATION_STRATEGY_LOWEST_ID = 3;
}


// =======================
// RAM
// =======================

message RamStorageConfig {
  bool enabled = 1;
  uint64 max_bytes = 2;
  string backing = 3; // tmpfs, hugetlbfs, etc.
}


// =======================
// DISK
// =======================

message DiskStorageConfig {
  bool enabled = 1;
  string root_path = 2;
  uint64 max_bytes = 3;
  bool fsync_by_default = 4;
}


// =======================
// OBJECT STORAGE (S3 / MINIO)
// =======================

message ObjectStorageConfig {
  bool enabled = 1;
  string endpoint = 2;
  string region = 3;
  string bucket = 4;
  string key_prefix = 5;
  ObjectStorageCredentials credentials = 6;
  bool force_path_style = 7;
  bool tls_enabled = 8;
  uint32 max_concurrency = 9;
  string storage_class = 10;
}

message ObjectStorageCredentials {
  string access_key_id = 1;
  string secret_access_key = 2;
}


// =======================
// LEASE CONFIG
// =======================

message LeaseConfig {
  google.protobuf.Duration default_lease_duration = 1;
  google.protobuf.Duration max_lease_duration = 2;
  google.protobuf.Duration reap_interval = 3;
}


// =======================
// OBSERVABILITY
// =======================

message ObservabilityConfig {
  bool enable_metrics = 1;
  string metrics_bind_address = 2;
  bool enable_audit_logs = 3;
}
